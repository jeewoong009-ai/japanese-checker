<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>우리말 일본어 잔재 검사기</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Pretendard", system-ui,
        -system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top left, #e3eeff, #f8f5ff 45%, #f9fafb 80%);
      color: #111827;
      overflow-x: hidden;
    }

    .page {
      width: 100%;
      max-width: 1120px;
      padding: 40px 20px 60px;
      animation: fadeIn 0.7s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    h1.title {
      margin: 0;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.03em;
      animation: slideDown 0.7s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .badge {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(55, 65, 81, 0.06);
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(156, 163, 175, 0.35);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-4px);
      }
    }

    .subtitle {
      margin: 0 0 22px;
      font-size: 15px;
      color: #6b7280;
      animation: fadeIn 0.8s ease-out 0.1s forwards;
      opacity: 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 22px 22px 26px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(12px);
      animation: popIn 0.8s ease-out 0.1s forwards;
      opacity: 0;
      transform: translateY(4px) scale(0.99);
    }

    @keyframes popIn {
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4f46e5;
    }

    textarea {
      width: 100%;
      height: 220px;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      padding: 14px 14px;
      font-size: 15px;
      resize: none;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease,
        transform 0.12s ease;
      background: #f9fafb;
    }

    textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.4),
        0 10px 25px rgba(79, 70, 229, 0.15);
      background: #ffffff;
      transform: translateY(-1px);
    }

    .button-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 11px 22px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease, opacity 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #ffffff;
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(79, 70, 229, 0.45);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }

    .status-text {
      margin-top: 8px;
      font-size: 13px;
      color: #6b7280;
      min-height: 18px;
    }

    .result-box {
      border-radius: 14px;
      border: 1px dashed #d1d5db;
      padding: 12px 12px;
      font-size: 14px;
      min-height: 220px;
      background: #f9fafb;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .result-box.active {
      background: #ffffff;
      border-style: solid;
      border-color: #a5b4fc;
      box-shadow: inset 0 0 0 1px rgba(129, 140, 248, 0.2);
    }

    .legend {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }

    .dot-loanword {
      background: #ef4444;
    }

    .dot-translationese {
      background: #f59e0b;
    }

    .dot-bureaucratese {
      background: #3b82f6;
    }

    .found-list {
      border-radius: 14px;
      border: 1px dashed #d1d5db;
      padding: 10px;
      min-height: 220px;
      background: #f9fafb;
      font-size: 14px;
      overflow-y: auto;
    }

    .found-empty {
      color: #9ca3af;
      font-size: 13px;
      margin-top: 6px;
    }

    .found-item {
      border-radius: 10px;
      padding: 9px 10px;
      margin-bottom: 8px;
      background: #eef2ff;
      border: 1px solid #e0e7ff;
      opacity: 0;
      transform: translateY(4px);
      animation: itemFadeIn 0.3s ease-out forwards;
    }

    @keyframes itemFadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .found-item:nth-child(1) { animation-delay: 0.02s; }
    .found-item:nth-child(2) { animation-delay: 0.06s; }
    .found-item:nth-child(3) { animation-delay: 0.10s; }

    .found-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tag-loanword {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
    }

    .tag-translationese {
      background: rgba(245, 158, 11, 0.08);
      color: #92400e;
    }

    .tag-bureaucratese {
      background: rgba(59, 130, 246, 0.08);
      color: #1d4ed8;
    }

    .found-span {
      font-weight: 700;
    }

    .found-note {
      margin-top: 2px;
      color: #4b5563;
    }

    .found-suggest {
      margin-top: 3px;
      color: #374151;
      font-size: 13px;
    }

    .highlight-loanword {
      background: rgba(239, 68, 68, 0.16);
      border-radius: 4px;
      padding: 0 2px;
    }

    .highlight-translationese {
      background: rgba(245, 158, 11, 0.18);
      border-radius: 4px;
      padding: 0 2px;
    }

    .highlight-bureaucratese {
      background: rgba(59, 130, 246, 0.16);
      border-radius: 4px;
      padding: 0 2px;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      animation: spin 0.65s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .card {
        padding: 18px 16px 22px;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <div class="header-row">
      <h1 class="title">우리말 일본어 잔재 검사기</h1>
      <div class="badge">10525 하지웅</div>
    </div>
    <p class="subtitle">한민고 1-5는 일본말 야레야레</p>

    <section class="card">
      <div class="grid">
        <!-- 입력 패널 -->
        <div>
          <div class="panel-title">
            <span class="dot"></span>
            입력 텍스트
          </div>
          <textarea id="inputText" placeholder="여기에 문장을 입력하세요."></textarea>
          <div class="button-row">
            <button class="btn-primary" id="checkBtn" onclick="checkText()">
              <span id="checkLabel">검사하기</span>
              <span id="checkSpinner" class="spinner" style="display:none;"></span>
            </button>
            <button class="btn-secondary" onclick="clearText()">지우기</button>
          </div>
          <div class="status-text" id="statusText"></div>
        </div>

        <!-- 결과(원문 + 하이라이트) -->
        <div>
          <div class="panel-title">
            <span class="dot"></span>
            결과
          </div>
          <div id="resultOriginal" class="result-box">
            아직 분석한 문장이 없습니다.
          </div>
          <div class="legend">
            <span><span class="badge-dot dot-loanword"></span> 일본어 기원어</span>
            <span><span class="badge-dot dot-translationese"></span> 일본식 번역투</span>
            <span><span class="badge-dot dot-bureaucratese"></span> 관청체·행정체</span>
          </div>
        </div>

        <!-- 발견된 표현 리스트 -->
        <div>
          <div class="panel-title">
            <span class="dot"></span>
            발견된 표현
          </div>
          <div id="foundList" class="found-list">
            <div class="found-empty">아직 분석 결과가 없습니다.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

        <script>
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function clearText() {
      document.getElementById("inputText").value = "";
      document.getElementById("statusText").textContent = "";
      document.getElementById("resultOriginal").classList.remove("active");
      document.getElementById("resultOriginal").innerHTML =
        "아직 분석한 문장이 없습니다.";
      document.getElementById("foundList").innerHTML =
        '<div class="found-empty">아직 분석 결과가 없습니다.</div>';
    }

    async function checkText() {
      const text = document.getElementById("inputText").value.trim();
      const status = document.getElementById("statusText");
      const resultOriginal = document.getElementById("resultOriginal");
      const foundList = document.getElementById("foundList");
      const btn = document.getElementById("checkBtn");
      const label = document.getElementById("checkLabel");
      const spinner = document.getElementById("checkSpinner");

      if (!text) {
        status.textContent = "먼저 문장을 입력하세요.";
        return;
      }

      status.textContent = "분석 중입니다...";
      btn.disabled = true;
      btn.style.opacity = "0.8";
      label.textContent = "검사 중";
      spinner.style.display = "inline-block";

      try {
        const response = await fetch("/api/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });

        const data = await response.json();

        // 버튼 상태 복구
        btn.disabled = false;
        btn.style.opacity = "1";
        label.textContent = "검사하기";
        spinner.style.display = "none";

        const rawItems = data.items || [];

        // 1) 완전 동일한 항목(start/end/type/span) 중복 제거
        const seenExact = new Set();
        const step1 = [];
        for (const item of rawItems) {
          const key = `${item.start}-${item.end}-${item.type}-${item.span}`;
          if (seenExact.has(key)) continue;
          seenExact.add(key);
          step1.push(item);
        }

        // 2) 같은 span + type 중복 제거 (설명/제안이 더 긴 쪽을 남김)
        const bySpanType = new Map();
        for (const item of step1) {
          const span = (item.span || "").trim();
          if (!span) continue;
          const key = `${span}:::${item.type || ""}`;
          const score =
            (item.note ? item.note.length : 0) +
            (item.suggestion ? item.suggestion.length : 0);

          if (!bySpanType.has(key)) {
            bySpanType.set(key, { item, score });
          } else {
            const existing = bySpanType.get(key);
            if (score > existing.score) {
              bySpanType.set(key, { item, score });
            }
          }
        }
        const finalItems = Array.from(bySpanType.values()).map((v) => v.item);

        if (finalItems.length === 0) {
          status.textContent =
            "일본어 기원어·번역투·관청체 표현을 찾지 못했습니다.";
          resultOriginal.classList.add("active");
          resultOriginal.textContent = text;
          foundList.innerHTML =
            '<div class="found-empty">발견된 일본어 잔재 표현이 없습니다.</div>';
          return;
        }

        status.textContent = `${finalItems.length}개의 표현을 발견했습니다.`;
        resultOriginal.classList.add("active");

        // 3) span 문자열 기준으로 위치 재계산 + 모든 등장 위치 하이라이트
        const ranges = [];

        function hasOverlap(start, end) {
          return ranges.some((r) => start < r.end && end > r.start);
        }

        for (const item of finalItems) {
          const span = (item.span || "").trim();
          if (!span) continue;

          const len = span.length;
          let idx = text.indexOf(span);

          // 같은 단어가 여러 번 나올 수 있으니
          // 겹치지 않는 모든 위치를 다 추가
          while (idx !== -1) {
            const start = idx;
            const end = idx + len;

            if (!hasOverlap(start, end)) {
              ranges.push({ start, end, item });
            }
            idx = text.indexOf(span, idx + 1);
          }
        }

        // 시작 위치 기준 정렬
        ranges.sort((a, b) => a.start - b.start);

        // 4) ranges를 이용해서 하이라이트 HTML 생성
        let cursor = 0;
        let html = "";

        for (const r of ranges) {
          const { start, end, item } = r;

          if (cursor < start) {
            html += escapeHtml(text.slice(cursor, start));
          }

          const spanText = escapeHtml(text.slice(start, end));

          let cls = "";
          if (item.type === "loanword") cls = "highlight-loanword";
          else if (item.type === "translationese")
            cls = "highlight-translationese";
          else if (item.type === "bureaucratese")
            cls = "highlight-bureaucratese";

          html += `<span class="${cls}">${spanText}</span>`;
          cursor = end;
        }

        if (cursor < text.length) {
          html += escapeHtml(text.slice(cursor));
        }

        resultOriginal.innerHTML = html;

        // 5) 오른쪽 카드: 문장 등장 순서대로 정렬
        //    ranges는 이미 start 기준으로 정렬되어 있으니,
        //    여기서 처음 등장하는 span+type 조합만 뽑아서 순서 리스트 생성
        const sidebarSeen = new Set();
        const orderedSidebarItems = [];
        for (const r of ranges) {
          const it = r.item;
          const span = (it.span || "").trim();
          if (!span) continue;
          const key = `${span}:::${it.type || ""}`;
          if (sidebarSeen.has(key)) continue;
          sidebarSeen.add(key);
          orderedSidebarItems.push(it);
        }

        // 6) 오른쪽 카드 렌더링
        foundList.innerHTML = "";
        orderedSidebarItems.forEach((item) => {
          const wrapper = document.createElement("div");
          wrapper.className = "found-item";

          let tagClass = "tag-translationese";
          let tagLabel = "일본식 번역투";
          if (item.type === "loanword") {
            tagClass = "tag-loanword";
            tagLabel = "일본어 기원어";
          } else if (item.type === "bureaucratese") {
            tagClass = "tag-bureaucratese";
            tagLabel = "관청체·행정체";
          }

          wrapper.innerHTML = `
            <div class="found-tag ${tagClass}">${tagLabel}</div>
            <div class="found-span">『${item.span}』</div>
            <div class="found-note">${item.note || "설명 없음"}</div>
            <div class="found-suggest">
              제안: <b>${item.suggestion || "별도의 대체 표현 없음"}</b>
            </div>
          `;

          foundList.appendChild(wrapper);
        });
      } catch (err) {
        console.error(err);
        status.textContent =
          "오류가 발생했습니다. 잠시 후 다시 시도해 주세요.";
        btn.disabled = false;
        btn.style.opacity = "1";
        label.textContent = "검사하기";
        spinner.style.display = "none";
      }
    }
  </script>
</body>
</html>
